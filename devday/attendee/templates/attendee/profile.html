{% extends "devday_site.html" %}
{% load i18n cms_tags crispy_forms_tags sekizai_tags %}
{% block title %}{% trans "Attendee profile" %}{% endblock %}
{% block content_body %}
    <div class="row">
        <div class="offset-lg-2 col-lg-8 col-12 content-area">
            <h1>{% blocktrans with username=user.get_username %}User profile for {{ username }}{% endblocktrans %}</h1>
            <div class="text-justify">{% static_placeholder "gdpr_teaser" %}</div>
            {% crispy form %}
        </div>
        {% if user.speaker %}
        <div class="offset-lg-2 col-lg-8 col-12 text-justify">
            {% url 'user_speaker_profile' as speaker_profile %}
            <h3>{% trans "Speaker" %}</h3>
            <p>{% blocktrans with speaker_name=user.speaker.name %}You are registered as speaker &quot;{{ speaker_name }}&quot;. Visit your <a href="{{ speaker_profile }}">speaker details page</a> to update your speaker data.{% endblocktrans %}</p>
        </div>
        {% endif %}
        <div class="offset-lg-2 col-lg-8 col-12">
            <h3>{%  trans "Events" %}</h3>
            {% if attendees %}
                <p>{% blocktrans %}You are registered for these events{% endblocktrans %}</p>
                <div class="table-responsive">
                    <table class="table">
                        {% for attendee in attendees %}
                            {% with event=attendee.event reservations=attendee.reservations.all %}
                            <tr>
                                <td>{{ event.title }}</td>
                                <td>{{ event.description }}
                                    {% if reservations %}
                                        <p><strong>{% trans "Workshops / Sessions" %}:</strong></p>
                                        <ul class="reservations">
                                        {% for reservation in reservations %}
                                            {% with talk=reservation.talk %}
                                                {% url 'talk_details' event=talk.event.slug slug=talk.slug as talk_details %}
                                                <a href="{{ talk_details }}">{{ talk.title }}</a>
                                                {% if event.id == current_event.id %}
                                                    {% if reservation.is_confirmed or reservation.is_waiting %}
                                                        <span class="fas fa-calendar-times"></span>
                                                            <a href="{% url "talk_cancel_reservation" event=talk.event.slug slug=talk.slug %}">{% trans "Cancel reservation" %}</a>
                                                    {% else %}
                                                        <span class="fas fa-send"></span>
                                                            <a href="{% url "talk_resend_confirmation" event=talk.event.slug slug=talk.slug %}">{% trans "Resend confirmation mail" %}</a>
                                                    {% endif %}
                                                {% endif %}
                                            {% endwith %}
                                        {% endfor %}
                                        </ul>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if event.id == current_event.id %}
                                        <div class="form-check-inline">
                                            <input class="form-check-input" type="checkbox" {% if attendee.rafle %}checked{% endif %} id="raffle-checkbox" data-toggle-url="{% url "attendee_toggle_raffle" event=event.slug %}">
                                            <label class="form-check-label">{% trans "Take part in the raffle" %}</label>
                                        </div>
                                        {% if not user.get_speaker %}
                                        <div class="btn-group float-left float-sm-right">
                                            <a class="btn btn-primary"
                                                  href="{% url "attendee_cancel" event=event.id %}">{% trans "Cancel Registration" %}</a>
                                        </div>
                                        {% endif %}
                                        {% addtoblock "js" %}
                                            <script type="text/javascript">
                                            function getCookie(name) {
                                            var cookieValue = null;
                                            if (document.cookie && document.cookie !== '') {
                                                var cookies = document.cookie.split(';');
                                                for (var i = 0; i < cookies.length; i++) {
                                                    var cookie = jQuery.trim(cookies[i]);
                                                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                                            break;
                                                        }
                                                    }
                                                }
                                                return cookieValue;
                                            }
                                            $(document).ready(function() {
                                                $("#raffle-checkbox").bind("change", function() {
                                                    let eventUrl = $(this).data("toggle-url");
                                                    $.ajax({
                                                        type: 'POST',
                                                        url: eventUrl,
                                                        data: {},
                                                        headers: {
                                                            "X-CSRFToken": getCookie("csrftoken")
                                                        },
                                                        success: function (data) {
                                                            $('#raffle-checkbox').checked = data["raffle"];
                                                        },
                                                        error: function(jqXHR, textStatus, errorThrown) {
                                                            alert(textStatus);
                                                        },
                                                        dataType: "json"
                                                    });
                                                });
                                            })
                                            </script>
                                        {% endaddtoblock %}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endwith %}
                        {% endfor %}
                    </table>
                </div>
            {% else %}
                <p>{% blocktrans %}You are not currently registered to participate in any event.{% endblocktrans %}</p>
            {% endif %}
        </div>
    </div>
    {% if events and checkin_code %}
    <div class="row">
        <div class="offset-lg-2 col-lg-8 col-12 content-area">
            {% include "attendee/checkin_qrcode_include.html" %}
        </div>
    </div>
    {% endif %}
{% endblock %}
